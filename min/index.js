function e(t,n=4,o=10,s=0,r=[],i=[]){let a=e=>{var t,a=0;if(i.length){for(t=c(e),a=0;a<t.length;a++)i[t[a]].insert(e);return e}if(r.push(e),r.length>n&&s<o){for(i.length||h(),a=0;a<r.length;a++){t=c(r[a]);for(var l=0;l<t.length;l++)i[t[l]].insert(r[a])}r=[]}return e},l=e=>{var t=c(e),n=r;if(i.length)for(var o=0;o<t.length;o++)n=n.concat(i[t[o]].retrieve(e));return n=n.filter((function(e,t){return n.indexOf(e)>=t}))},c=e=>{var n=[],o=t.x+t.width/2,s=t.y+t.height/2,r=e.y<s,i=e.x<o,a=e.x+e.width>o,l=e.y+e.height>s;return r&&a&&n.push(0),i&&r&&n.push(1),i&&l&&n.push(2),a&&l&&n.push(3),n},h=n=>{var o=t.width/2,s=t.height/2,r=t.x,a=t.y;const l=(t,n)=>e({x:t,y:n,width:o,height:s});i[0]=l(r+o,a),i[1]=l(r,a),i[2]=l(r,a+s),i[3]=l(r+o,a+o)},u=e=>{r=[];for(let e=0;e<i.length;e++)i.length&&i[e].clear();i=[]};return console.log("made a new tree",{insert:a,retrieve:l,getIndex:c,split:h,clear:u}),{insert:a,retrieve:l,getIndex:c,split:h,clear:u}}let t=(e,n)=>{let o=((e=!0)=>[1,16/15,9/8,1.2,5/4,4/3,e?45/32:25/18])(),s=o.length-1;return n<=s?e*o[n]:(n-=s,t(t(e,s),n))};const n=new AudioContext,o=n.createDelay(4);function s(e,t=[]){this.ac=n,this.createFxNodes(),this.tempo=e||120,this.loop=!0,this.smoothing=0,this.staccato=0,this.notes=t}o.delayTime.value=.125,o.connect(n.destination),s.prototype.createFxNodes=function(){let e=this.gain=this.ac.createGain();return[["bass",100],["mid",1e3],["treble",2500]].forEach(function(t,n){(n=this[t[0]]=this.ac.createBiquadFilter()).type="peaking",n.frequency.value=t[1],e.connect(e=n)}.bind(this)),this.lp=this.ac.createBiquadFilter(),this.lp.type="lowpass",this.lp.frequency.value=15e3,e.connect(e=this.lp),this.hp=this.ac.createBiquadFilter(),this.hp.type="highpass",this.hp.frequency.value=80,e.connect(e=this.hp),e.connect(this.ac.destination),this},s.prototype.createOscillator=function(){return this.stop(),this.osc=this.ac.createOscillator(),this.osc.type=this.waveType||"square",this.gain.value=.1,"lead"==this.type&&(this.osc.connect(o),this.osc.connect(this.ac.destination),this.osc.connect(this.ac.destination)),this.osc.connect(this.gain),this},s.prototype.scheduleNote=function(e,t){const n=60/this.tempo*this.notes[e][1],o=n*(1-(this.staccato||0));return this.setFrequency(this.notes[e][0],t),this.smoothing&&this.notes[e][0]&&this.slide(e,t,o),this.setFrequency(0,t+o),t+n},s.prototype.getNextNote=function(e){return this.notes[e<this.notes.length-1?e+1:0]},s.prototype.getSlideStartDelay=function(e){return e-Math.min(e,60/this.tempo*this.smoothing)},s.prototype.slide=function(e,t,n){const o=this.getNextNote(e),s=this.getSlideStartDelay(n);return this.setFrequency(this.notes[e][0],t+s),this.rampFrequency(o[0],t+n),this},s.prototype.setFrequency=function(e,t){return this.osc.frequency.setValueAtTime(e,t),this},s.prototype.rampFrequency=function(e,t){return this.osc.frequency.linearRampToValueAtTime(e,t),this},s.prototype.play=function(e){return e="number"==typeof e?e:this.ac.currentTime,this.createOscillator(),this.osc.start(e+1),this.notes.forEach(function(t,n){e=this.scheduleNote(n,e)}.bind(this)),this.osc.stop(e),this},s.prototype.stop=function(){return this.osc&&(this.osc.stop(0),this.osc.frequency.cancelScheduledValues(0),this.osc=null),this};const r=(e,n=(e=>1),o=[])=>o.map((o,s)=>[isNaN(o)?0:t(e,o),n(s)]),i=(e,t,n)=>{const o=new s(t,n);return o.staccato=.55,o.gain.gain.value=1,o.bass.frequency.value=400,o.bass.gain.value=-4,o.mid.frequency.value=800,o.mid.gain.value=3,o.waveType="square",o.hp.frequency.value=1200,o.role="lead",function(){return o.play(e),o}},a=(e,t,n)=>{const o=new s(t,n);return o.mid.frequency.value=1200,o.gain.gain.value=.8,o.staccato=.55,o.waveType="triangle",function(){return o.play(e),o}},l=(e,t,n)=>{const o=new s(t,n);return o.staccato=.05,o.smoothing=.05,o.gain.gain.value=.65,o.mid.gain.value=3,o.bass.gain.value=6,o.bass.frequency.value=80,o.mid.gain.value=-2,o.mid.frequency.value=500,o.treble.gain.value=-4,o.treble.frequency.value=1400,o.waveType="square",function(){return o.play(e),o}};function c(e){return 60/e}const{abs:h,sin:u,cos:d,pow:p,sqrt:y,floor:g,ceil:f,random:m,PI:b,max:v,min:w}=Math;var x,j;!function(e){e[e.bass=0]="bass",e[e.tenor=1]="tenor",e[e.alto=2]="alto",e[e.soprano=3]="soprano"}(x||(x={})),function(e){e[e.Blue=0]="Blue",e[e.Red=1]="Red",e[e.Yellow=2]="Yellow"}(j||(j={}));const O={[j.Red]:{rgb:[255,0,0]},[j.Blue]:{rgb:[0,0,255]},[j.Yellow]:{rgb:[0,255,0]}},q={[x.bass]:{colorMod:(e,t)=>255==e?50:e,text:"#"},[x.tenor]:{colorMod:(e,t)=>255==e?100:e,text:"\\-"},[x.alto]:{colorMod:(e,t)=>255==e?175:e,text:"=/"},[x.soprano]:{colorMod:(e,t)=>255,text:"@"}},N={[j.Yellow]:{tonic:88,bpm:70,voices:{[x.bass]:[0,5,0,7],[x.tenor]:[0,5,NaN,5],[x.alto]:[7,2,NaN],[x.soprano]:[12,4,NaN,12,7,NaN,4,7]}},[j.Red]:{tonic:52,bpm:93.333,voices:{[x.bass]:[7,0],[x.tenor]:[4,4,2,4],[x.alto]:[7,4,7,NaN],[x.soprano]:[12,NaN,NaN,0]}},[j.Blue]:{tonic:128,bpm:62.22,voices:{[x.bass]:[12,0,NaN,0],[x.tenor]:[0,4,0],[x.alto]:[7,NaN,12],[x.soprano]:[4,NaN,NaN,12,7,4,7,NaN]}}},k=(x.bass,x.tenor,x.alto,x.soprano,[(e,t)=>g(R(e,2*t.level+5)%255),(e,t)=>g(R(e,51+t.level)%255),(e,t)=>g(R(e,91-t.level)%255),(e,t)=>g(e+3)]),D=(e,t,n)=>k[e%k.length](t,n),I=(e,t)=>e.objectID!=t.objectID&&!(e.x>t.x+t.width||e.x+t.width<t.x||e.y>t.y+t.height||e.y+t.height<t.y),S={drone(e,t){const n=t.reduce((t,n)=>((e,t)=>{const n=Object.assign({},t),o=[[x.bass,x.soprano],[x.tenor,x.alto]];let s=0;for(let t of o)t.includes(e)&&(s=t[0]==e?1:2,n[e].volume=n[e].volume-s);return n})(e.room.role,e.ensemble),t),o=t.map(e=>e.objectID),s=e.drones.filter(e=>!o.includes(e.objectID));return Object.assign(Object.assign({},e),{drones:s,ensemble:n})},element(e,t){if(0==e.level&&t.length>1)return e;const n=t[0],o={clan:n.clan,role:0==e.level?x.bass:n.role},s=Q(e.ensemble,o.clan,o.role);return Object.assign(Object.assign({},e),{ensemble:s,room:o,drops:[],level:e.level+1})}},T=window.innerWidth,E=window.innerHeight,F=w(100,T/6),M={canvasWidth:T,canvasHeight:E},B=()=>B.prev++;B.prev=0;const R=(e,t=3)=>e*p(10,-t),A=e=>!isNaN(e)&&"number"==typeof e,$=(e,t=((e,t)=>e))=>{if(3!=e.length)return"";const[n,o,s]=e.map(t).map(e=>e.toString());return`rgb(${n},${o},${s})`},L=(e=0,t=1)=>g(m()*(g(t)-f(e)+1))+f(e),P=(e,t=1)=>{let n=e.lastwalk?"x":"y";return Object.assign(Object.assign({},e),{lastwalk:!e.lastwalk,[n]:Math.random()<.5?e[n]+1:e[n]-1})},W=(e,t=7)=>Object.assign(Object.assign({},e),{x:e.x>0?e.x-=t:0}),Y=(e,t=7)=>Object.assign(Object.assign({},e),{x:e.x<T-80?e.x+=t:T-80}),C=(e,t=7)=>Object.assign(Object.assign({},e),{y:e.y>=0?e.y-=t:80}),H=(e,t=7)=>Object.assign(Object.assign({},e),{y:e.y<=E?e.y+=t:E}),V=(e=3)=>{const t=[],n=T/e,o=(E+F)/2,s=2*T/e/e;for(let e=0;e<3;e++){const r=n+e*s,i=o;t.push(G({x:r,y:i,role:x.bass,clan:j[j[e]]}))}return t},G=(e={})=>Object.assign(Object.assign({clan:"",x:0,y:0,radius:F,dr:(e,t)=>g(F*h(u(t.objectID+R(e)))),width:0,height:0},e),{name:"element",objectID:B()}),U=(e,t)=>{let n={ArrowRight:Y,ArrowLeft:W,ArrowDown:H,ArrowUp:C};return Object.keys(n).includes(t)?n[t](e):e},z=(e,t)=>{let n=t.shots;ne.controls.includes("f")&&(n=n.concat(((e={})=>Object.assign({objectID:B(),name:"shot",x:0,y:0,radius:0,dr:(e,t,n)=>{const o=g(T/3),s=(+new Date-t.start)/t.duration;return s>1?0:g(o*s)},start:+new Date,duration:2e3},e))({start:+new Date,x:t.player.x,y:t.player.y,duration:200})),ne.controls=ne.controls.filter(e=>"f"!=e));return Object.assign(Object.assign({},t),{shots:n.filter(e=>1!==g(+new Date/(e.start+(e.duration+0)))),player:ne.controls.reduce(U,t.player)})},J=(e,t)=>{const n=e.dr(t,e);return Object.assign(Object.assign({},e),{radius:n,width:n/2,height:n/2})},K=(e,t)=>(e.insert(t),e),Q=(e,t,n,o=2)=>{if(e[n].clan!=t){const s=N[t];e[n].clan=t,e[n].volume=o,e[n].bpm=s.bpm,e[n].tonic=s.tonic,e[n].melody=s.voices[n]}else e[n].volume+=o;return e};const X=e=>.5,Z=e=>1/(e+1),_=e=>.85,ee=e=>.99,te=e=>({[x.bass]:X,[x.tenor]:_,[x.alto]:Z,[x.soprano]:ee}[e]||_);function ne(){const t={player:{objectID:B(),name:"player",width:80,height:80,x:T/2,y:E/5,volume:100,speed:100,luck:100},ensemble:{[x.bass]:{volume:1},[x.tenor]:{volume:1},[x.alto]:{volume:1},[x.soprano]:{volume:1}},drones:[],shots:[],drops:V(),room:{clan:null,role:x.bass},level:0},o=(e,t,n)=>{var o;if(1==n.volume)return void(void 0!==n.sequencer&&(n.sequencer.stop(),delete n.sequencer));const s=function(e){return{[x.bass]:l,[x.tenor]:a,[x.alto]:i,[x.soprano]:a}[e]||a}(t),h=function(e,t,n=[]){const o=c(t),s=e%(o*n.length);return n.findIndex((e,t)=>s<=(t+1)*o)}(e,n.bpm,n.melody);if(void 0===n.sequencer){const o=r(n.tonic,te(t),(u=h,[...(d=n.melody).concat().slice(u,d.length),...d.concat().slice(0,u)])),i=s(e,n.bpm,o);return n.sequencer=i(),void(n.sequencer.osc.onended=()=>{delete n.sequencer})}var u,d;if(void 0===(null===(o=null==n?void 0:n.sequencer)||void 0===o?void 0:o.osc.onended)&&h==n.melody.length-1){c(n.bpm),r(n.tonic,te(t),n.melody);n.sequencer.osc.onended=()=>{delete n.sequencer}}},s=(e,t)=>{var n,s;n=t.currentTime,s=e.ensemble,Object.entries(s).forEach(([e,t])=>o(n,parseInt(e),t))},h=(e,t)=>n=>{t.shots.forEach((t,o)=>{n.strokeStyle=$([(t.x+t.y)%100,t.x%255,t.y%200]),n.arc(t.x,t.y,t.radius,0,2*b),n.lineWidth=e%20,n.stroke()})},u=(e,t)=>{const n="!*!";return e=>{const o=e.measureText(n);t.player.height=o.actualBoundingBoxAscent+o.actualBoundingBoxDescent,t.player.width=o.width,e.fillStyle="white",e.strokeStyle="black",e.strokeText(n,t.player.x,t.player.y),e.fillText(n,t.player.x,t.player.y)}},d=(e,t,n)=>{let o=30,s=T/o,r=E/30;for(let i=0;i<s;i++){let s=i*R(e,3)%255;for(let a=0;a<r;a++){let r=D(a,e,n),l=D(i+a,e,n);t.fillStyle=`rgb(${s}, ${r}, ${l})`,t.fillRect(i*o-i,30*a-a,i*o+o,a*o+o)}}},p=(e,t)=>{let n=Object.keys(j).map(e=>parseInt(e)).filter(e=>e!==t).filter(A),o=(E-40)/3;e.fillStyle=$(O[n[0]].rgb),e.fillRect(0,o,20,o+40),e.fillStyle=$(O[n[1]].rgb),e.fillRect(T-0-20,o,T-0+20,o+40)},y=(e,t,n)=>{if(!0===e.repeat)return;"f"==e.key&&ne.controls.includes(e.key)?ne.controls=ne.controls.filter(t=>t!==e.key):ne.controls=ne.controls.concat(e.key);const o=t=>{e.key===t.key&&(ne.controls=ne.controls.filter(t=>t!==e.key),window.removeEventListener("keyup",o))};window.addEventListener("keyup",o)},f=(e=4,t=[])=>0===e?t:(t=t.concat(((e={})=>Object.assign({objectID:B(),name:"drone",x:.7*Math.random()*T,y:.7*Math.random()*E,width:40,height:40,lastwalk:!1},e))()),f(e-1,t)),m=(e,t,n)=>{n(((e,t)=>n=>{d(e,n,t)})(e,t)),n(((e,t)=>{const n=O[t.room.clan],o=q[t.room.role];return e=>{t.drones.forEach((t,s)=>{const{x:r,y:i}=t,a=o.text.repeat(2),l=e.measureText(a);t.width=l.width,e.fillStyle=$(n.rgb,o.colorMod),e.fillText(a,g(r+50),g(i+50))})}})(0,t)),n(h(e,t)),n(u(0,t))},v=(e,t,n)=>{n(((e,t)=>{const n=[0,0,0];return o=>{p(o,t.room.clan),t.drops.forEach(({x:t,y:s,width:r,height:i},a)=>{for(let r=0;r<3;r++){n[a]=255;const i=+R(e)+b*r/4,l=Math.PI/4+i;o.fillStyle=$(n),o.arc(t,s,30,i,l),o.stroke(),o.fill()}})}})(e,t)),n(u(0,t))},w=(e,t)=>("function"==typeof w.prev&&window.removeEventListener("keydown",w.prev),window.addEventListener("keydown",w.prev=e=>y(e)),t),N=e=>Object.keys(e).map(e=>parseInt(e)).filter(A),k=e=>{const t=((e,t)=>{const n=N(j).filter(t=>t!=e),o=N(x).filter(e=>e!=t);return{clan:n[L(0,n.length-1)],role:o[L(0,o.length-1)]}})(e.room.clan,e.room.role),n=f(2*e.level);return Object.assign(Object.assign({},e),{drones:n,room:t})},F=(e,t,o,r)=>{r.clear();let i=z(0,t);i=((e,t)=>Object.assign(Object.assign({},t),{shots:t.shots.map(e=>J(e,+new Date)),drops:t.drops.map(t=>J(t,e)),drones:t.drones.map(P)}))(e,i),r=((e,t,n)=>[t.player,...t.drones,...t.drops,...t.shots].reduce(K,n))(0,i,r),s(i,n);let a=((e,t)=>{const n=e.drones.reduce((e,n)=>{const o=t.retrieve(n).filter(e=>I(e,n));return e.concat(o)},[]);return[...t.retrieve(e.player).filter(t=>I(t,e.player)),...n]})(i,r);if(a.length>0&&(i=((e,t,n="")=>{""===n&&(n=t[0].name);const o=S[n];return void 0===o?e:o(e,t)})(i,a)),i.shots.length>0&&i.drones.length>0){let e=i.shots.reduce((e,t,n)=>{const o=r.retrieve(t).filter(e=>I(e,t));return e.filter(e=>!o.includes(e))},i.drones);i=Object.assign(Object.assign({},i),{drones:e})}Object.values(i.ensemble).some(e=>0==e.volume)&&location.reload(),t.level!=i.level?i=k(i):0==i.drones.length&&0==i.drops.length&&(i=(e=>{const t=G({name:"element",x:T/2,y:E/2,clan:e.room.clan,role:e.room.role});return Object.assign(Object.assign({},e),{drops:[t]})})(i)),w(e,i),((e,t,n)=>{if(n(e=>e.clearRect(0,0,T,E)),0==t.level)return W(e,t,n),void n(h(e,t));t.drops.length>0?v(e,t,n):m(e,t,n)})(e,i,o),requestAnimationFrame(e=>F(e,i,o,r))},W=(e,t,n)=>{const o=N(j);o.length;n(n=>d(e,n,t)),t.drops.forEach((e,t)=>{n(n=>{const o=O[t],s=q[t];n.fillStyle=n.strokeStyle=$(o.rgb,s[t]),n.arc(e.x,e.y,e.radius,0,2*Math.PI),n.fill(),n.stroke()})}),n(u(0,t))};((t,n,o)=>{const{canvasWidth:s,canvasHeight:r}=o,i=document.createElement("canvas");i.width=s,i.height=r;const a=i.getContext("2d");a.font="50px monospace",document.body.appendChild(i);n(0,t,e=>{a.beginPath(),a.lineWidth=8,e(a),a.closePath()},e({x:0,y:0,width:s,height:r},3,4))})(t,F,M)}ne.controls=[],ne();
