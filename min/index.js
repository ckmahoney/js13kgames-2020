function e(e,t=4,n=10,s=0){this.max_objects=t||10,this.max_levels=n||4,this.level=s||0,this.bounds=e,this.objects=[],this.nodes=[]}var t,n,s,o;e.prototype.split=function(){var t=this.level+1,n=this.bounds.width/2,s=this.bounds.height/2,o=this.bounds.x,i=this.bounds.y;this.nodes[0]=new e({x:o+n,y:i,width:n,height:s},this.max_objects,this.max_levels,t),this.nodes[1]=new e({x:o,y:i,width:n,height:s},this.max_objects,this.max_levels,t),this.nodes[2]=new e({x:o,y:i+s,width:n,height:s},this.max_objects,this.max_levels,t),this.nodes[3]=new e({x:o+n,y:i+s,width:n,height:s},this.max_objects,this.max_levels,t)},e.prototype.getIndex=function(e){var t=[],n=this.bounds.x+this.bounds.width/2,s=this.bounds.y+this.bounds.height/2,o=e.y<s,i=e.x<n,r=e.x+e.width>n,a=e.y+e.height>s;return o&&r&&t.push(0),i&&o&&t.push(1),i&&a&&t.push(2),r&&a&&t.push(3),t},e.prototype.insert=function(e){var t,n=0;if(this.nodes.length){for(t=this.getIndex(e),n=0;n<t.length;n++)this.nodes[t[n]].insert(e);return e}if(this.objects.push(e),this.objects.length>this.max_objects&&this.level<this.max_levels){for(this.nodes.length||this.split(),n=0;n<this.objects.length;n++){t=this.getIndex(this.objects[n]);for(var s=0;s<t.length;s++)this.nodes[t[s]].insert(this.objects[n])}this.objects=[]}return e},e.prototype.retrieve=function(e){var t=this.getIndex(e),n=this.objects;if(this.nodes.length)for(var s=0;s<t.length;s++)n=n.concat(this.nodes[t[s]].retrieve(e));return n=n.filter((function(e,t){return n.indexOf(e)>=t}))},e.prototype.clear=function(){this.objects=[];for(let e=0;e<this.nodes.length;e++)this.nodes.length&&this.nodes[e].clear();this.nodes=[]},function(e){e[e.C=0]="C",e[e.Cs=1]="Cs",e[e.D=2]="D",e[e.Ds=3]="Ds",e[e.E=4]="E",e[e.F=5]="F",e[e.Fs=6]="Fs",e[e.G=7]="G",e[e.Gs=8]="Gs",e[e.A=9]="A",e[e.As=10]="As",e[e.B=11]="B"}(t||(t={})),function(e){e[e.Unison=0]="Unison",e[e.MinorSecond=1]="MinorSecond",e[e.MajorSecond=2]="MajorSecond",e[e.MinorThird=3]="MinorThird",e[e.MajorThird=4]="MajorThird",e[e.PerfectFourth=5]="PerfectFourth",e[e.Tritone=6]="Tritone",e[e.PerfectFifth=7]="PerfectFifth",e[e.MinorSixth=8]="MinorSixth",e[e.MajorSixth=9]="MajorSixth",e[e.MinorSeventh=10]="MinorSeventh",e[e.MajorSeventh=11]="MajorSeventh"}(n||(n={})),function(e){e[e.Tonic=0]="Tonic",e[e.Supertonic=1]="Supertonic",e[e.Mediant=2]="Mediant",e[e.Subdominant=3]="Subdominant",e[e.Dominant=4]="Dominant",e[e.Submediant=5]="Submediant",e[e.Leading=6]="Leading"}(s||(s={})),function(e){e[e.sine=0]="sine",e[e.square=1]="square",e[e.sawtooth=2]="sawtooth",e[e.triangle=3]="triangle"}(o||(o={}));let i=(e,t)=>{let n=r(),s=n.length-1;return t<=s?e*n[t]:(t-=s,i(i(e,s),t))},r=(e=!0)=>[1,16/15,9/8,1.2,5/4,4/3,e?45/32:25/18];const a=new AudioContext,l=a.createDelay(4);function c(e,t=[]){this.ac=a,this.createFxNodes(),this.tempo=e||120,this.loop=!0,this.smoothing=0,this.staccato=0,this.notes=t}l.delayTime.value=.125,l.connect(a.destination),c.prototype.createFxNodes=function(){let e=this.gain=this.ac.createGain();return[["bass",100],["mid",1e3],["treble",2500]].forEach(function(t,n){(n=this[t[0]]=this.ac.createBiquadFilter()).type="peaking",n.frequency.value=t[1],e.connect(e=n)}.bind(this)),this.lp=this.ac.createBiquadFilter(),this.lp.type="lowpass",this.lp.frequency.value=15e3,e.connect(e=this.lp),this.hp=this.ac.createBiquadFilter(),this.hp.type="highpass",this.hp.frequency.value=80,e.connect(e=this.hp),e.connect(this.ac.destination),this},c.prototype.createOscillator=function(){return this.stop(),this.osc=this.ac.createOscillator(),this.osc.type=this.waveType||"square",this.gain.value=.1,"lead"==this.type&&(this.osc.connect(l),this.osc.connect(this.ac.destination),this.osc.connect(this.ac.destination)),this.osc.connect(this.gain),this},c.prototype.scheduleNote=function(e,t){const n=60/this.tempo*this.notes[e][1],s=n*(1-(this.staccato||0));return this.setFrequency(this.notes[e][0],t),this.smoothing&&this.notes[e][0]&&this.slide(e,t,s),this.setFrequency(0,t+s),t+n},c.prototype.getNextNote=function(e){return this.notes[e<this.notes.length-1?e+1:0]},c.prototype.getSlideStartDelay=function(e){return e-Math.min(e,60/this.tempo*this.smoothing)},c.prototype.slide=function(e,t,n){const s=this.getNextNote(e),o=this.getSlideStartDelay(n);return this.setFrequency(this.notes[e][0],t+o),this.rampFrequency(s[0],t+n),this},c.prototype.setFrequency=function(e,t){return this.osc.frequency.setValueAtTime(e,t),this},c.prototype.rampFrequency=function(e,t){return this.osc.frequency.linearRampToValueAtTime(e,t),this},c.prototype.play=function(e){return e="number"==typeof e?e:this.ac.currentTime,this.createOscillator(),this.osc.start(e+1),this.notes.forEach(function(t,n){e=this.scheduleNote(n,e)}.bind(this)),this.osc.stop(e),this},c.prototype.stop=function(){return this.osc&&(this.osc.stop(0),this.osc.frequency.cancelScheduledValues(0),this.osc=null),this};const h=(e,t=(e=>1),n=[])=>n.map((n,s)=>[isNaN(n)?0:i(e,n),t(s)]),u=(e,t,n)=>{const s=new c(t,n);return s.staccato=.55,s.gain.gain.value=1,s.bass.frequency.value=400,s.bass.gain.value=-4,s.mid.frequency.value=800,s.mid.gain.value=3,s.waveType="square",s.hp.frequency.value=1200,s.role="lead",function(){return s.play(e),s}},d=(e,t,n)=>{const s=new c(t,n);return s.mid.frequency.value=1200,s.gain.gain.value=.8,s.staccato=.55,s.waveType="triangle",function(){return s.play(e),s}},p=(e,t,n)=>{const s=new c(t,n);return s.staccato=.05,s.smoothing=.05,s.gain.gain.value=.65,s.mid.gain.value=3,s.bass.gain.value=6,s.bass.frequency.value=80,s.mid.gain.value=-2,s.mid.frequency.value=500,s.treble.gain.value=-4,s.treble.frequency.value=1400,s.waveType="square",function(){return s.play(e),s}};function y(e){return 60/e}const{abs:b,sin:g,cos:f,pow:m,sqrt:v,floor:x,ceil:w,random:j,PI:O,max:q,min:N}=Math;var S,M;!function(e){e[e.bass=0]="bass",e[e.tenor=1]="tenor",e[e.alto=2]="alto",e[e.soprano=3]="soprano"}(S||(S={})),function(e){e[e.Blue=0]="Blue",e[e.Red=1]="Red",e[e.Yellow=2]="Yellow"}(M||(M={}));const k={[M.Red]:{rgb:[255,0,0]},[M.Blue]:{rgb:[0,0,255]},[M.Yellow]:{rgb:[0,255,0]}},D={[S.bass]:{colorMod:(e,t)=>255==e?50:e,text:"#"},[S.tenor]:{colorMod:(e,t)=>255==e?100:e,text:"\\-"},[S.alto]:{colorMod:(e,t)=>255==e?175:e,text:"=/"},[S.soprano]:{colorMod:(e,t)=>255,text:"@"}},T={[M.Yellow]:{tonic:88,bpm:70,voices:{[S.bass]:[0,5,0,7],[S.tenor]:[0,5,NaN,5],[S.alto]:[7,2,NaN],[S.soprano]:[12,4,NaN,12,7,NaN,4,7]}},[M.Red]:{tonic:52,bpm:93.333,voices:{[S.bass]:[7,0],[S.tenor]:[4,4,2,4],[S.alto]:[7,4,7,NaN],[S.soprano]:[12,NaN,NaN,0]}},[M.Blue]:{tonic:128,bpm:62.22,voices:{[S.bass]:[12,0,NaN,0],[S.tenor]:[0,4,0],[S.alto]:[7,NaN,12],[S.soprano]:[4,NaN,NaN,12,7,4,7,NaN]}}},F=(S.bass,S.tenor,S.alto,S.soprano,[(e,t)=>x(L(e,2*t.level+5)%255),(e,t)=>x(L(e,51+t.level)%255),(e,t)=>x(L(e,91-t.level)%255),(e,t)=>x(e+3)]),I=(e,t,n)=>F[e%F.length](t,n),E=(e,t)=>e.objectID!=t.objectID&&!(e.x>t.x+t.width||e.x+t.width<t.x||e.y>t.y+t.height||e.y+t.height<t.y),A={drone(e,t){const n=t.reduce((t,n)=>((e,t)=>{const n=Object.assign({},t),s=[[S.bass,S.soprano],[S.tenor,S.alto]];let o=0;for(let t of s)t.includes(e)&&(o=t[0]==e?1:2,n[e].volume=n[e].volume-o);return n})(e.room.role,e.ensemble),t),s=t.map(e=>e.objectID),o=e.drones.filter(e=>!s.includes(e.objectID));return Object.assign(Object.assign({},e),{drones:o,ensemble:n})},element(e,t){if(0==e.level&&t.length>1)return e;const n=t[0],s={clan:n.clan,role:0==e.level?S.bass:n.role},o=te(e.ensemble,s.clan,s.role);return Object.assign(Object.assign({},e),{ensemble:o,room:s,drops:[],level:e.level+1})}},B=window.innerWidth,_=window.innerHeight,R=N(100,B/6),P={canvasWidth:B,canvasHeight:_},C=()=>C.prev++;C.prev=0;const L=(e,t=3)=>e*m(10,-t),$=e=>!isNaN(e)&&"number"==typeof e,G=(e,t=((e,t)=>e))=>{if(3!=e.length)return"";const[n,s,o]=e.map(t).map(e=>e.toString());return`rgb(${n},${s},${o})`},W=(e=0,t=1)=>x(j()*(x(t)-w(e)+1))+w(e),Y=(e,t=1)=>{let n=e.lastwalk?"x":"y";return Object.assign(Object.assign({},e),{lastwalk:!e.lastwalk,[n]:Math.random()<.5?e[n]+1:e[n]-1})},H=(e,t=7)=>Object.assign(Object.assign({},e),{x:e.x>0?e.x-=t:0}),U=(e,t=7)=>Object.assign(Object.assign({},e),{x:e.x<B-80?e.x+=t:B-80}),V=(e,t=7)=>Object.assign(Object.assign({},e),{y:e.y>=0?e.y-=t:80}),z=(e,t=7)=>Object.assign(Object.assign({},e),{y:e.y<=_?e.y+=t:_}),J=(e=3)=>{const t=[],n=B/e,s=(_+R)/2,o=2*B/e/e;for(let e=0;e<3;e++){const i=n+e*o,r=s;t.push(K({x:i,y:r,role:S.bass,clan:M[M[e]]}))}return t},K=(e={})=>Object.assign(Object.assign({clan:"",x:0,y:0,radius:R,dr:(e,t)=>x(R*b(g(t.objectID+L(e)))),width:0,height:0},e),{name:"element",objectID:C()}),Q=(e,t)=>{let n={ArrowRight:U,ArrowLeft:H,ArrowDown:z,ArrowUp:V};return Object.keys(n).includes(t)?n[t](e):e},X=(e,t)=>{let n=t.shots;ae.controls.includes("f")&&(n=n.concat(((e={})=>Object.assign({objectID:C(),name:"shot",x:0,y:0,radius:0,dr:(e,t,n)=>{const s=x(B/3),o=(+new Date-t.start)/t.duration;return o>1?0:x(s*o)},start:+new Date,duration:2e3},e))({start:+new Date,x:t.player.x,y:t.player.y,duration:200})),ae.controls=ae.controls.filter(e=>"f"!=e));return Object.assign(Object.assign({},t),{shots:n.filter(e=>1!==x(+new Date/(e.start+(e.duration+0)))),player:ae.controls.reduce(Q,t.player)})},Z=(e,t)=>{const n=e.dr(t,e);return Object.assign(Object.assign({},e),{radius:n,width:n/2,height:n/2})},ee=(e,t)=>(e.insert(t),e),te=(e,t,n,s=2)=>{if(e[n].clan!=t){const o=T[t];e[n].clan=t,e[n].volume=s,e[n].bpm=o.bpm,e[n].tonic=o.tonic,e[n].melody=o.voices[n]}else e[n].volume+=s;return e};const ne=e=>.5,se=e=>1/(e+1),oe=e=>.85,ie=e=>.99,re=e=>({[S.bass]:ne,[S.tenor]:oe,[S.alto]:se,[S.soprano]:ie}[e]||oe);function ae(){const t={player:{objectID:C(),name:"player",width:80,height:80,x:B/2,y:_/5,volume:100,speed:100,luck:100},ensemble:{[S.bass]:{volume:1},[S.tenor]:{volume:1},[S.alto]:{volume:1},[S.soprano]:{volume:1}},drones:[],shots:[],drops:J(),room:{clan:null,role:S.bass},level:0},n=(e,t,n)=>{var s;if(1==n.volume)return void(void 0!==n.sequencer&&(n.sequencer.stop(),delete n.sequencer));const o=function(e){return{[S.bass]:p,[S.tenor]:d,[S.alto]:u,[S.soprano]:d}[e]||d}(t),i=function(e,t,n=[]){const s=y(t),o=e%(s*n.length);return n.findIndex((e,t)=>o<=(t+1)*s)}(e,n.bpm,n.melody);if(void 0===n.sequencer){const s=h(n.tonic,re(t),(r=i,[...(a=n.melody).concat().slice(r,a.length),...a.concat().slice(0,r)])),l=o(e,n.bpm,s);return n.sequencer=l(),void(n.sequencer.osc.onended=()=>{delete n.sequencer})}var r,a;if(void 0===(null===(s=null==n?void 0:n.sequencer)||void 0===s?void 0:s.osc.onended)&&i==n.melody.length-1){y(n.bpm),h(n.tonic,re(t),n.melody);n.sequencer.osc.onended=()=>{delete n.sequencer}}},s=(e,t)=>{var s,o;s=t.currentTime,o=e.ensemble,Object.entries(o).forEach(([e,t])=>n(s,parseInt(e),t))},o=(e,t)=>n=>{t.shots.forEach((t,s)=>{n.strokeStyle=G([(t.x+t.y)%100,t.x%255,t.y%200]),n.arc(t.x,t.y,t.radius,0,2*O),n.lineWidth=e%20,n.stroke()})},i=(e,t)=>{const n="!*!";return e=>{const s=e.measureText(n);t.player.height=s.actualBoundingBoxAscent+s.actualBoundingBoxDescent,t.player.width=s.width,e.fillStyle="white",e.strokeStyle="black",e.strokeText(n,t.player.x,t.player.y),e.fillText(n,t.player.x,t.player.y)}},r=(e,t,n)=>{let s=30,o=B/s,i=_/30;for(let r=0;r<o;r++){let o=r*L(e,3)%255;for(let a=0;a<i;a++){let i=I(a,e,n),l=I(r+a,e,n);t.fillStyle=`rgb(${o}, ${i}, ${l})`,t.fillRect(r*s-r,30*a-a,r*s+s,a*s+s)}}},l=(e,t)=>{let n=Object.keys(M).map(e=>parseInt(e)).filter(e=>e!==t).filter($),s=(_-40)/3;e.fillStyle=G(k[n[0]].rgb),e.fillRect(0,s,20,s+40),e.fillStyle=G(k[n[1]].rgb),e.fillRect(B-0-20,s,B-0+20,s+40)},c=(e,t,n)=>{if(!0===e.repeat)return;"f"==e.key&&ae.controls.includes(e.key)?ae.controls=ae.controls.filter(t=>t!==e.key):ae.controls=ae.controls.concat(e.key);const s=t=>{e.key===t.key&&(ae.controls=ae.controls.filter(t=>t!==e.key),window.removeEventListener("keyup",s))};window.addEventListener("keyup",s)},b=(e=4,t=[])=>0===e?t:(t=t.concat(((e={})=>Object.assign({objectID:C(),name:"drone",x:.7*Math.random()*B,y:.7*Math.random()*_,width:40,height:40,lastwalk:!1},e))()),b(e-1,t)),g=(e,t,n)=>{n(((e,t)=>n=>{r(e,n,t)})(e,t)),n(((e,t)=>{const n=k[t.room.clan],s=D[t.room.role];return e=>{t.drones.forEach((t,o)=>{const{x:i,y:r}=t,a=s.text.repeat(2),l=e.measureText(a);t.width=l.width,e.fillStyle=G(n.rgb,s.colorMod),e.fillText(a,x(i+50),x(r+50))})}})(0,t)),n(o(e,t)),n(i(0,t))},f=(e,t,n)=>{n(((e,t)=>{const n=[0,0,0];return s=>{l(s,t.room.clan),t.drops.forEach(({x:t,y:o,width:i,height:r},a)=>{for(let i=0;i<3;i++){n[a]=255;const r=+L(e)+O*i/4,l=Math.PI/4+r;s.fillStyle=G(n),s.arc(t,o,30,r,l),s.stroke(),s.fill()}})}})(e,t)),n(i(0,t))},m=(e,t)=>("function"==typeof m.prev&&window.removeEventListener("keydown",m.prev),window.addEventListener("keydown",m.prev=e=>c(e)),t),v=e=>Object.keys(e).map(e=>parseInt(e)).filter($),w=e=>{const t=((e,t)=>{const n=v(M).filter(t=>t!=e),s=v(S).filter(e=>e!=t);return{clan:n[W(0,n.length-1)],role:s[W(0,s.length-1)]}})(e.room.clan,e.room.role),n=b(2*e.level);return Object.assign(Object.assign({},e),{drones:n,room:t})},j=(e,t,n,i)=>{i.clear();let r=X(0,t);r=((e,t)=>Object.assign(Object.assign({},t),{shots:t.shots.map(e=>Z(e,+new Date)),drops:t.drops.map(t=>Z(t,e)),drones:t.drones.map(Y)}))(e,r),i=((e,t,n)=>[t.player,...t.drones,...t.drops,...t.shots].reduce(ee,n))(0,r,i),s(r,a);let l=((e,t)=>{const n=e.drones.reduce((e,n)=>{const s=t.retrieve(n).filter(e=>E(e,n));return e.concat(s)},[]);return[...t.retrieve(e.player).filter(t=>E(t,e.player)),...n]})(r,i);if(l.length>0&&(r=((e,t,n="")=>{""===n&&(n=t[0].name);const s=A[n];return void 0===s?e:s(e,t)})(r,l)),r.shots.length>0&&r.drones.length>0){let e=r.shots.reduce((e,t,n)=>{const s=i.retrieve(t).filter(e=>E(e,t));return e.filter(e=>!s.includes(e))},r.drones);r=Object.assign(Object.assign({},r),{drones:e})}Object.values(r.ensemble).some(e=>0==e.volume)&&location.reload(),t.level!=r.level?r=w(r):0==r.drones.length&&0==r.drops.length&&(r=(e=>{const t=K({name:"element",x:B/2,y:_/2,clan:e.room.clan,role:e.room.role});return Object.assign(Object.assign({},e),{drops:[t]})})(r)),m(e,r),((e,t,n)=>{if(n(e=>e.clearRect(0,0,B,_)),0==t.level)return q(e,t,n),void n(o(e,t));t.drops.length>0?f(e,t,n):g(e,t,n)})(e,r,n),requestAnimationFrame(e=>j(e,r,n,i))},q=(e,t,n)=>{const s=v(M);s.length;n(n=>r(e,n,t)),t.drops.forEach((e,t)=>{n(n=>{const s=k[t],o=D[t];n.fillStyle=n.strokeStyle=G(s.rgb,o[t]),n.arc(e.x,e.y,e.radius,0,2*Math.PI),n.fill(),n.stroke()})}),n(i(0,t))};((t,n,s)=>{const{canvasWidth:o,canvasHeight:i}=s,r=document.createElement("canvas");r.width=o,r.height=i;const a=r.getContext("2d");a.font="50px monospace",document.body.appendChild(r);n(0,t,e=>{a.beginPath(),a.lineWidth=8,e(a),a.closePath()},new e({x:0,y:0,width:o,height:i},3,4))})(t,j,P)}ae.controls=[],ae();
